<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EQ - My Studio</title>
    <!-- 공통 스타일과 EQ 전용 스타일을 링크합니다. -->
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/eq.css">
</head>
<body>
    <!-- 헤더를 공통 스타일로 변경합니다. -->
    <header class="app-header">
        <div class="logo">
            <a href="index.html">STUDIO</a>
        </div>
        <nav class="navigation">
            <a href="eq.html" class="nav-btn active">EQ</a>
            <a href="convert.html" class="nav-btn">Transform</a>
        </nav>
    </header>

    <!-- content-area를 main-content 클래스를 가진 main 태그로 변경합니다. -->
    <main class="main-content">
        <div class="audio-controls">
            <div id="audio-info" class="audio-info">
                테스트 음원: Sine Wave 1kHz
            </div>
            <div class="control-buttons">
                <button id="play-pause-btn">▶ 재생</button>
                <button id="eq-toggle-btn" class="on">EQ ON</button>
            </div>
        </div>

        <div class="toggle-switch">
            <div id="geq" class="toggle-option active">Graphic EQ</div>
            <div id="peq" class="toggle-option">Parametric EQ</div>
        </div>
        
        <div class="eq-panel">
            <div class="controls-section">
                <div id="geq-controls" class="eq-controls visible">
                    <h2>GEQ 컨트롤 (31 Band)</h2>
                    <p>슬라이더를 조절하여 각 주파수 대역의 게인을 변경합니다.</p>
                    <ul class="geq-slider-list" id="geq-list-container">
                        <!-- JS로 내용 채워짐 -->
                    </ul>
                </div>

                <div id="peq-controls" class="eq-controls">
                    <h2>PEQ 필터 목록</h2>
                    <p>필터를 추가하고 그래프의 점을 움직여 EQ를 조절하세요.</p>
                    <ul class="peq-filter-list" id="peq-filter-list">
                        <!-- JS로 내용 채워짐 -->
                    </ul>
                    <button id="add-filter-btn">+ 필터 추가</button>
                </div>
            </div>

            <div class="graph-section">
                <div class="y-labels">
                    <span>+15</span><span>+12</span><span>+9</span><span>+6</span><span>+3</span>
                    <span>0</span>
                    <span>-3</span><span>-6</span><span>-9</span><span>-12</span><span>-15</span>
                </div>
                
                <div id="graph-visualization">
                    <!-- JS로 PEQ 점들 채워짐 -->
                </div>
                
                <div class="freq-labels">
                    <span>10</span><span>50</span><span>100</span><span>200</span><span>500</span>
                    <span>1k</span><span>5k</span><span>10k</span><span>20k</span>
                </div>
            </div>
        </div>
    </main>

    <!-- 팝업 창은 원본 그대로 유지 -->
    <div id="param-popup" class="param-popup">
        <h4 id="popup-title"></h4>
        <div class="input-group">
            <label for="popup-type">유형</label>
            <select id="popup-type" onchange="updateFilterData(selectedFilterId, 'type', this.value)">
                <option value="PEAK">Peak/Dip</option>
                <option value="LSH">Low Shelf</option>
                <option value="HSH">High Shelf</option>
            </select>
        </div>
        <div class="input-group">
            <label for="popup-freq">Freq (Hz)</label>
            <input type="number" id="popup-freq" step="1" min="10" max="20000" onchange="updateFilterData(selectedFilterId, 'freq', this.value)">
        </div>
        <div class="input-group">
            <label for="popup-gain">Gain (dB)</label>
            <input type="number" id="popup-gain" step="0.1" min="-15" max="15" onchange="updateFilterData(selectedFilterId, 'gain', this.value)">
        </div>
        <div class="input-group">
            <label for="popup-q">Q 값</label>
            <input type="number" id="popup-q" step="0.01" min="0.7" max="100" onchange="updateFilterData(selectedFilterId, 'q', this.value)">
        </div>
        <button class="delete-btn-graph" id="popup-delete-btn">필터 삭제</button>
    </div>

    <!-- === JAVASCRIPT === -->
    <script>
        const GEQ_FREQUENCIES = [
            20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 
            630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000, 
            10000, 12500, 16000, 20000
        ];
        const MIN_FREQ = 10;
        const MAX_FREQ = 20000;
        const MIN_GAIN = -15;
        const MAX_GAIN = 15;

        let peqFilters = [];
        let nextFilterId = 1;
        let selectedFilterId = null;

        // 주파수(Hz)를 그래프 X축 좌표(0-100%)로 변환 (로그 스케일)
        function freqToX(freq) {
            const logMin = Math.log10(MIN_FREQ);
            const logMax = Math.log10(MAX_FREQ);
            const logFreq = Math.log10(freq);
            return ((logFreq - logMin) / (logMax - logMin)) * 100;
        }

        // 게인(dB)을 그래프 Y축 좌표(0-100%)로 변환 (선형 스케일)
        function gainToY(gain) {
            return 100 - (((gain - MIN_GAIN) / (MAX_GAIN - MIN_GAIN)) * 100);
        }

        // X축 좌표(0-100%)를 주파수(Hz)로 변환
        function xToFreq(x) {
            const logMin = Math.log10(MIN_FREQ);
            const logMax = Math.log10(MAX_FREQ);
            const logFreq = logMin + (logMax - logMin) * (x / 100);
            return Math.pow(10, logFreq);
        }

        // Y축 좌표(0-100%)를 게인(dB)으로 변환
        function yToGain(y) {
            return MAX_GAIN - ((y / 100) * (MAX_GAIN - MIN_GAIN));
        }

        // GEQ 슬라이더 생성 함수
        function createGeqSliders() {
            const container = document.getElementById('geq-list-container');
            container.innerHTML = ''; 
            GEQ_FREQUENCIES.forEach((freq) => {
                const li = document.createElement('li');
                const freqLabel = freq >= 1000 ? `${(freq/1000).toFixed(1).replace('.0','')}k` : freq;
                li.innerHTML = `
                    <label>${freqLabel} Hz Gain</label>
                    <div class="slider-wrapper">
                        <input type="range" min="${MIN_GAIN}" max="${MAX_GAIN}" step="0.1" value="0" id="geq-${freq}">
                        <input type="number" class="control-input" value="0.0" step="0.1" data-freq="${freq}">
                        <span>dB</span>
                    </div>
                `;
                container.appendChild(li);

                const slider = li.querySelector('input[type="range"]');
                const numInput = li.querySelector('input[type="number"]');
                slider.oninput = (e) => numInput.value = parseFloat(e.target.value).toFixed(1);
                numInput.onchange = (e) => slider.value = parseFloat(e.target.value);
            });
        }
        
        // --- PEQ 관련 함수 ---
        function addPeqFilterData() {
            const newFilter = {
                id: nextFilterId++,
                freq: 1000,
                gain: 0.0,
                q: 1.41,
                type: 'PEAK'
            };
            peqFilters.push(newFilter);
            return newFilter;
        }

        function updateFilterData(id, key, value) {
            const filter = peqFilters.find(f => f.id == id);
            if (!filter) return;

            let val = (key === 'type') ? value : parseFloat(value);
            if (key === 'freq') val = Math.max(MIN_FREQ, Math.min(MAX_FREQ, val));
            if (key === 'gain') val = Math.max(MIN_GAIN, Math.min(MAX_GAIN, val));
            if (key === 'q') val = Math.max(0.7, Math.min(100, val));
            
            filter[key] = val;
            
            if(selectedFilterId == id) {
                selectFilter(id, false); 
            }
            
            renderAllPeq(); 
        }

        function renderPeqList() {
            const listContainer = document.getElementById('peq-filter-list');
            listContainer.innerHTML = '';

            peqFilters.forEach(filter => {
                const li = document.createElement('li');
                li.setAttribute('data-id', filter.id);
                li.innerHTML = `
                    <div><span class="filter-id">${filter.id}</span> 필터 ${filter.id}</div>
                    <span style="font-size: 12px; color: var(--text-medium);">${filter.freq.toFixed(0)}Hz / ${filter.gain.toFixed(1)}dB</span>
                `;
                li.onclick = () => selectFilter(filter.id);
                listContainer.appendChild(li);
            });
        }

        function renderPeqDots() {
            const graphViz = document.getElementById('graph-visualization');
            // 기존 점들 모두 제거
            graphViz.querySelectorAll('.peq-dot').forEach(dot => dot.remove());

            // PEQ 모드일 때만 점들을 그림
            if (document.getElementById('peq').classList.contains('active')) {
                peqFilters.forEach(filter => {
                    const dot = document.createElement('div');
                    dot.className = 'peq-dot';
                    dot.textContent = filter.id;
                    dot.setAttribute('data-id', filter.id);
                    
                    const xPos = freqToX(filter.freq);
                    const yPos = gainToY(filter.gain);

                    dot.style.left = `${xPos}%`;
                    dot.style.top = `${yPos}%`;
                    dot.style.transform = 'translate(-50%, -50%)'; 

                    dot.onclick = (e) => { e.stopPropagation(); selectFilter(filter.id); };
                    dot.onmousedown = (e) => startDrag(e, filter.id);
                    dot.addEventListener('wheel', (e) => adjustQ(e, filter.id));

                    graphViz.appendChild(dot);
                });
            }
        }
        
        function selectFilter(id, repositionPopup = true) {
            const filter = peqFilters.find(f => f.id == id);
            if (!filter) return;

            selectedFilterId = id;
            const popup = document.getElementById('param-popup');
            
            document.getElementById('popup-title').textContent = `필터 ${id} 파라미터 (${filter.type})`;
            document.getElementById('popup-freq').value = filter.freq.toFixed(0);
            document.getElementById('popup-gain').value = filter.gain.toFixed(1);
            document.getElementById('popup-q').value = filter.q.toFixed(2);
            document.getElementById('popup-type').value = filter.type;
            document.getElementById('popup-delete-btn').onclick = () => deleteFilter(id);

            if (repositionPopup) {
                const dotElement = document.querySelector(`.peq-dot[data-id="${id}"]`);
                if (dotElement) {
                    const rect = dotElement.getBoundingClientRect();
                    const graphRect = document.getElementById('graph-visualization').getBoundingClientRect();
                    
                    let left = rect.left - graphRect.left + 35;
                    let top = rect.top - graphRect.top;

                    if (left + 210 > graphRect.width) { 
                        left = rect.left - graphRect.left - 210;
                    }
                    
                    popup.style.left = `${left}px`;
                    popup.style.top = `${top}px`;
                }
            }
            popup.style.display = 'block';
            
            document.querySelectorAll('.peq-dot').forEach(d => d.classList.remove('selected'));
            const selectedDot = document.querySelector(`.peq-dot[data-id="${id}"]`);
            if (selectedDot) selectedDot.classList.add('selected');
        }

        function deleteFilter(id) {
            peqFilters = peqFilters.filter(f => f.id !== id);
            selectedFilterId = null;
            document.getElementById('param-popup').style.display = 'none';
            renderAllPeq(); 
        }

        function renderAllPeq() {
            renderPeqList();
            renderPeqDots();
        }

        function startDrag(e, id) {
            e.preventDefault();
            selectFilter(id, true);
            const dot = document.querySelector(`.peq-dot[data-id="${id}"]`);
            const graphRect = document.getElementById('graph-visualization').getBoundingClientRect();
            
            function onMouseMove(e) {
                let xPct = ((e.clientX - graphRect.left) / graphRect.width) * 100;
                let yPct = ((e.clientY - graphRect.top) / graphRect.height) * 100;

                xPct = Math.max(0, Math.min(100, xPct));
                yPct = Math.max(0, Math.min(100, yPct));

                const currentFilter = peqFilters.find(f => f.id === id);
                currentFilter.freq = xToFreq(xPct);
                currentFilter.gain = yToGain(yPct);
                
                updateFilterData(id, 'freq', currentFilter.freq);
                updateFilterData(id, 'gain', currentFilter.gain);

                selectFilter(id, true);
            }

            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function adjustQ(e, id) {
            e.preventDefault();
            e.stopPropagation(); 
            const filter = peqFilters.find(f => f.id === id);
            if (!filter) return;
            
            const delta = e.deltaY < 0 ? filter.q * 0.1 : filter.q * -0.1;
            updateFilterData(id, 'q', parseFloat(filter.q) + delta);
        }

        document.addEventListener('click', (e) => {
            const popup = document.getElementById('param-popup');
            if (popup.style.display === 'block' && 
                !popup.contains(e.target) && 
                !e.target.closest('.peq-dot')) {
                popup.style.display = 'none';
                document.querySelectorAll('.peq-dot').forEach(d => d.classList.remove('selected'));
                selectedFilterId = null;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const geqOption = document.getElementById('geq');
            const peqOption = document.getElementById('peq');
            const geqControls = document.getElementById('geq-controls');
            const peqControls = document.getElementById('peq-controls');
            const addFilterBtn = document.getElementById('add-filter-btn');

            function updateModeDisplay(type) {
                geqOption.classList.toggle('active', type === 'geq');
                peqOption.classList.toggle('active', type === 'peq');
                
                geqControls.classList.toggle('visible', type === 'geq');
                peqControls.classList.toggle('visible', type === 'peq');
                
                document.getElementById('param-popup').style.display = 'none';
                renderAllPeq(); 
            }
            
            createGeqSliders();
            addPeqFilterData();
            addPeqFilterData();
            renderAllPeq(); 

            updateModeDisplay('geq');
            
            addFilterBtn.addEventListener('click', () => {
                const newFilter = addPeqFilterData();
                renderAllPeq();
                // 새 필터 추가 후 그래프에 점이 렌더링된 후 selectFilter 호출
                setTimeout(() => selectFilter(newFilter.id), 0);
            });
            
            geqOption.addEventListener('click', () => updateModeDisplay('geq'));
            peqOption.addEventListener('click', () => updateModeDisplay('peq'));
        });
    </script>
</body>
</html>